---
- name: Créer groupe hadoop
  group:
    name: "{{ hadoop_group }}"
    state: present

- name: Créer utilisateur hadoop
  user:
    name: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    shell: /bin/bash
    home: /home/{{ hadoop_user }}
    createhome: yes

- name: Installer dépendances Java
  apt:
    name:
      - openjdk-11-jdk
      - wget
      - rsync
    state: present
    update_cache: yes

- name: Créer répertoires HDFS
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    mode: '0755'
  loop:
    - "{{ hadoop_install_dir }}"
    - "{{ hdfs_namenode_dir }}"
    - "{{ hdfs_datanode_dir }}"
    - "{{ hdfs_tmp_dir }}"
    - /var/log/hadoop

- name: Vérifier si Hadoop est déjà installé
  stat:
    path: "{{ hadoop_home }}/bin/hadoop"
  register: hadoop_installed

- name: Télécharger Hadoop
  get_url:
    url: "{{ hadoop_download_url }}"
    dest: "/tmp/hadoop-{{ hadoop_version }}.tar.gz"
    timeout: 300
  when: not hadoop_installed.stat.exists

- name: Extraire Hadoop
  unarchive:
    src: "/tmp/hadoop-{{ hadoop_version }}.tar.gz"
    dest: "{{ hadoop_install_dir }}"
    remote_src: yes
    extra_opts: [--strip-components=1]
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
  when: not hadoop_installed.stat.exists

- name: Configurer variables d'environnement Hadoop
  template:
    src: hadoop-env.sh.j2
    dest: "{{ hadoop_conf_dir }}/hadoop-env.sh"
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    mode: '0644'

- name: Configurer core-site.xml
  template:
    src: core-site.xml.j2
    dest: "{{ hadoop_conf_dir }}/core-site.xml"
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    mode: '0644'

- name: Configurer hdfs-site.xml
  template:
    src: hdfs-site.xml.j2
    dest: "{{ hadoop_conf_dir }}/hdfs-site.xml"
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    mode: '0644'

- name: Configurer workers (ancien slaves)
  template:
    src: workers.j2
    dest: "{{ hadoop_conf_dir }}/workers"
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    mode: '0644'

- name: Ajouter variables d'environnement au profil système
  blockinfile:
    path: /etc/profile.d/hadoop.sh
    create: yes
    block: |
      export HADOOP_HOME={{ hadoop_home }}
      export HADOOP_CONF_DIR={{ hadoop_conf_dir }}
      export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin
      export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    mode: '0644'

- name: Donner les permissions à l'utilisateur hadoop
  file:
    path: "{{ hadoop_home }}"
    owner: "{{ hadoop_user }}"
    group: "{{ hadoop_group }}"
    recurse: yes